<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bluesadi","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="VariableRecovery is an important component in decompilation pipeline. In this blog, we will dive into the implementation of VariableRecoveryFast in angr.">
<meta property="og:type" content="article">
<meta property="og:title" content="VariableRecovery Internals in angr">
<meta property="og:url" content="https://bluesadi/2024/04/27/VariableRecovery-Internals-in-angr/index.html">
<meta property="og:site_name" content="34r7hm4n&#39;s blog">
<meta property="og:description" content="VariableRecovery is an important component in decompilation pipeline. In this blog, we will dive into the implementation of VariableRecoveryFast in angr.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-04-27T18:32:30.000Z">
<meta property="article:modified_time" content="2024-04-29T21:50:29.678Z">
<meta property="article:author" content="Yibo Liu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bluesadi/2024/04/27/VariableRecovery-Internals-in-angr/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://bluesadi/2024/04/27/VariableRecovery-Internals-in-angr/","path":"2024/04/27/VariableRecovery-Internals-in-angr/","title":"VariableRecovery Internals in angr"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>VariableRecovery Internals in angr | 34r7hm4n's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">34r7hm4n's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#the-basics"><span class="nav-number">1.</span> <span class="nav-text">The Basics</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#decompilation-pipeline"><span class="nav-number">1.1.</span> <span class="nav-text">Decompilation Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forward-analysis"><span class="nav-number">1.2.</span> <span class="nav-text">Forward Analysis</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#high-level-idea"><span class="nav-number">2.</span> <span class="nav-text">High-level Idea</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dive-into-the-engine"><span class="nav-number">3.</span> <span class="nav-text">Dive Into the Engine</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yibo Liu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Yibo Liu</p>
  <div class="site-description" itemprop="description">I am a first year PhD student at <a href=https://sefcom.asu.edu/>SEFCOM</a> at Arizona State University. I am interested in reverse engineering and decompilation.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/bluesadi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;bluesadi" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yiboliu@asu.edu" title="E-Mail → mailto:yiboliu@asu.edu" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/34r7hm4n" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;34r7hm4n" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://bluesadi/2024/04/27/VariableRecovery-Internals-in-angr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yibo Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="34r7hm4n's blog">
      <meta itemprop="description" content="I am a first year PhD student at <a href=https://sefcom.asu.edu/>SEFCOM</a> at Arizona State University. I am interested in reverse engineering and decompilation.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="VariableRecovery Internals in angr | 34r7hm4n's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          VariableRecovery Internals in angr
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 04-27-2024 11:32:30" itemprop="dateCreated datePublished" datetime="2024-04-27T11:32:30-07:00">04-27-2024</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 04-29-2024 14:50:29" itemprop="dateModified" datetime="2024-04-29T14:50:29-07:00">04-29-2024</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>VariableRecovery is an important component in decompilation pipeline.
In this blog, we will dive into the implementation of
VariableRecoveryFast in angr.</p>
<span id="more"></span>
<h2 id="the-basics">The Basics</h2>
<h3 id="decompilation-pipeline">Decompilation Pipeline</h3>
<p>Let's take a look at the simplified decompilation pipeline of angr.
Given a binary, angr first loads it properly according to its format
(e.g., ELF, PE, or even Intel Hex), gaining some necessary information
for decompilation, such as segmentation information. For code segment,
the Instruction Set Architecture (ISA) is identified by angr to lift the
platform-dependent assembly code to platform-independent VEX IR. Based
on VEX IR, a control flow graph is recovered by CFG Generation
algorithms. The recovered CFG is program-wide and then be converted to a
set of function-wide CFGs, and at the same time, VEX IR is converted to
a higher-level IR - angr Intermediate Language (AIL), for future
decompilation. Each AIL graph will be handled with a sequence of
simplification passes. Then Variable Recovery comes into play,
traversing each AIL statement and expression in the function and
assigning variables and type constraints to them. Based on the variables
recovered and type constraints collected by Variable Recovery, Type
Recovery then infers and assigns a type for each variable by solving
type constraints. Eventually, AIL graph will be structured into a
sequence of high-level program structures (e.g., for loop, if-else) and
structured pseudo-code is outputed to decompiler users. <img
src="/2024/04/27/VariableRecovery-Internals-in-angr/decompilation_pipeline.png" /></p>
<h3 id="forward-analysis">Forward Analysis</h3>
<p>Forward analysis is a program analysis term, which is also heavily
used in angr. Say you want to traverse a control flow graph from the
entry block, how would you do that? You would probably use a Broad First
Search (BFS) strategy, starting with the entry block, then adding its
successors into the queue, getting a new block from the queue and
repeating the process. Forward analysis is a similar but more
sophisticated strategy, where a block can be put into the queue multiple
times until it reaches a limitation of iterations or all of its
predecessors don't produce anything new in current iteration.</p>
<h2 id="high-level-idea">High-level Idea</h2>
<p>In the decompilation pipeline, the entry point of Variable Recovery
is the <a
target="_blank" rel="noopener" href="https://github.com/angr/angr/blob/af87b435ffbe897d5b3a2147263963c869103590/angr/analyses/decompiler/clinic.py#L1108">_recover_and_link_variables</a>
in <code>Clinic.py</code>. This function calls VariableRecoveryFast
analysis and Typehoon analysis, for variable recovery and type inference
respectively. The results of Variable Recovery are SSA variables and the
statements/expressions that they are bound to. &gt; In compiler design,
static single assignment form (often abbreviated as SSA form or simply
SSA) is a property of an intermediate representation (IR) that requires
each variable to be assigned exactly once and defined before it is
used.</p>
<p>In the context of Variable Recovery, SSA means each variable is only
bound to one statement/expression, even though different SSA variables
could be the same variable in reality (like two stack variables with the
same base and offset are actually the same variable). At the end of
<code>_recover_and_link_variables</code>, SSA variables will be unified,
which means different SSA variables that are actually the same will be
able to mapped to one unified variable. That being said, SSA variables
will still be bound to every statement/expression.</p>
<p>However, as we all know, C/C++ is not a SSA programming language, so
we need to map the SSA variables into the unified variables at some
point. In angr, during <a
target="_blank" rel="noopener" href="https://github.com/angr/angr/blob/69f5da7f6b45bb27f3ff69c299871f8cf79b140f/angr/analyses/decompiler/structured_codegen/c.py">Structured
Code Generation</a>, the SSA variable bound to each AIL statement will
be used to get the corresponding unified variable, and only the unified
variable will be used to generate pseudo-code. That's why only unified
variables are used in the final outputed pseudo-code. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_variable</span>(<span class="params">self, variable: SimVariable, fallback_type_size: <span class="type">Optional</span>[<span class="built_in">int</span>]</span>) -&gt; CVariable:</span><br><span class="line">    unified = self._variable_kb.variables[self._func.addr].unified_variable(variable)</span><br><span class="line">    ...</span><br><span class="line">    cvar = CVariable(variable, unified_variable=unified, variable_type=variable_type, codegen=self)</span><br></pre></td></tr></table></figure></p>
<h2 id="dive-into-the-engine">Dive Into the Engine</h2>
<p>Basically, VariableRecoveryFast traverses all the blocks in a
function, for each block, the statements in the block are handled by <a
target="_blank" rel="noopener" href="https://github.com/angr/angr/blob/69f5da7f6b45bb27f3ff69c299871f8cf79b140f/angr/analyses/variable_recovery/engine_ail.py#L26">SimEngineVRAIL</a>
sequentially. Each statement will be handled by different handler
function in the engine based on the statement type. ###
_ail_handle_assignment <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dst = src (dst and src should be Register or Tmp)</span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/01/05/Linkage-Types-in-LLVM/" rel="prev" title="Linkage Types in LLVM">
                  <i class="fa fa-angle-left"></i> Linkage Types in LLVM
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Yibo Liu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
