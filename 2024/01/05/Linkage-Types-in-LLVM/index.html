<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bluesadi","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Like many other C&#x2F;C++ compilers, LLVM also needs to inform the linker (ld, lld, etc.) how to merge global values (global variables, functions) of different modules (one module in LLVM corresponds to">
<meta property="og:type" content="article">
<meta property="og:title" content="Linkage Types in LLVM">
<meta property="og:url" content="https://bluesadi/2024/01/05/Linkage-Types-in-LLVM/index.html">
<meta property="og:site_name" content="34r7hm4n&#39;s blog">
<meta property="og:description" content="Like many other C&#x2F;C++ compilers, LLVM also needs to inform the linker (ld, lld, etc.) how to merge global values (global variables, functions) of different modules (one module in LLVM corresponds to">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-01-05T07:08:08.000Z">
<meta property="article:modified_time" content="2024-04-27T18:32:38.837Z">
<meta property="article:author" content="Yibo Liu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://bluesadi/2024/01/05/Linkage-Types-in-LLVM/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://bluesadi/2024/01/05/Linkage-Types-in-LLVM/","path":"2024/01/05/Linkage-Types-in-LLVM/","title":"Linkage Types in LLVM"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linkage Types in LLVM | 34r7hm4n's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">34r7hm4n's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#privatelinkage"><span class="nav-number">1.</span> <span class="nav-text">PrivateLinkage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#externallinkage"><span class="nav-number">2.</span> <span class="nav-text">ExternalLinkage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#appendinglinkage"><span class="nav-number">3.</span> <span class="nav-text">AppendingLinkage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkonceanylinkage-linkonceodrlinkage"><span class="nav-number">4.</span> <span class="nav-text">LinkOnceAnyLinkage &amp;
LinkOnceODRLinkage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#inline-function"><span class="nav-number">4.1.</span> <span class="nav-text">Inline Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template-function"><span class="nav-number">4.2.</span> <span class="nav-text">Template Function</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#weakanylinkage-weakodrlinkage"><span class="nav-number">5.</span> <span class="nav-text">WeakAnyLinkage &amp;
WeakODRLinkage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#commonlinkage"><span class="nav-number">6.</span> <span class="nav-text">CommonLinkage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#availableexternallylinkage"><span class="nav-number">7.</span> <span class="nav-text">AvailableExternallyLinkage</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yibo Liu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Yibo Liu</p>
  <div class="site-description" itemprop="description">I am a first year PhD student at <a href=https://sefcom.asu.edu/>SEFCOM</a> at Arizona State University. I am interested in reverse engineering and decompilation.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/bluesadi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;bluesadi" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yiboliu@asu.edu" title="E-Mail → mailto:yiboliu@asu.edu" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/34r7hm4n" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;34r7hm4n" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://bluesadi/2024/01/05/Linkage-Types-in-LLVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yibo Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="34r7hm4n's blog">
      <meta itemprop="description" content="I am a first year PhD student at <a href=https://sefcom.asu.edu/>SEFCOM</a> at Arizona State University. I am interested in reverse engineering and decompilation.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linkage Types in LLVM | 34r7hm4n's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linkage Types in LLVM
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 01-05-2024 00:08:08" itemprop="dateCreated datePublished" datetime="2024-01-05T00:08:08-07:00">01-05-2024</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 04-27-2024 11:32:38" itemprop="dateModified" datetime="2024-04-27T11:32:38-07:00">04-27-2024</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Like many other C/C++ compilers, LLVM also needs to inform the linker
(ld, lld, etc.) how to merge global values (global variables, functions)
of different modules (one module in LLVM corresponds to one object file
or one translation unit for linker) at link-time. In LLVM, global values
can be divided into 10 categories according to their linkage types. The
linker will treat each type of global values differently based on their
linkage types. Not considering the linkage types of global values when
writing a LLVM Pass may result in unexpected behaviors, especially when
you are manipulating the global variables by a Module Pass. In this
post, I will demystify the 10 linkage types in LLVM to help you write
more robust LLVM Passes.</p>
<span id="more"></span>
<h2 id="privatelinkage">PrivateLinkage</h2>
<p>To start off, let's have a look at the simplest linkage type in LLVM
- PrivateLinkage. PrivateLinkage means the global value should only be
used in current LLVM Module (one LLVM Module usually corresponds to one
object file). Because private global values are local to current module,
no symbol needs to show up in any symbol table in the object file. One
typical example is constant string as shown below.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;this is a private global variable&quot;</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After compiled to LLVM IR, it becomes a global variable with
<code>private</code> prefix, which means it has a private linkage type.
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@.str</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">34</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;this is a private global variable<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: mustprogress noinline norecurse optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local noundef <span class="type">i32</span> <span class="title">@main</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@puts</span>(<span class="type">i8</span>* noundef <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">34</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">34</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> This is quite straightforward and intuitive. In C/C++,
anonymous strings can only be used in current file (more precisely, it
can only be used in where it's defined), and obviously it won't have any
symbol in the symbol table.</p>
<p>If two objects have two private global variables with the same name,
they will be renamed to avoid collision. Let's compile two cpp files
with two strings with the same name, and link then through llvm-link to
get the merged LLVM IR.</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 1.ll compiled from 1.cpp</span></span><br><span class="line"><span class="title">@.str</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">5</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;test<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 2.ll compiled from 2.cpp</span></span><br><span class="line"><span class="title">@.str</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">28</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;this is a ? global variable<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>After linking, one of the variable is renamed to <code>.str.1</code>
to avoid collision. <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; llvm-link -S 1.ll 2.ll</span></span><br><span class="line"><span class="title">@.str</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">5</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;test<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br><span class="line"><span class="title">@.str.1</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">28</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;this is a ? global variable<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br></pre></td></tr></table></figure> ## InternalLinkage What if the consant
string is named and with a static modifier? <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> str[] = <span class="string">&quot;this is a ? global variable&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="built_in">puts</span>(str); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This time the global variable's prefix changes from
<code>private</code> to <code>internal</code>, which means it has an
internal linkage type. <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@_ZL3str</span> <span class="operator">=</span> <span class="keyword">internal</span> <span class="keyword">constant</span> [<span class="number">28</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;this is a ? global variable<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: mustprogress noinline norecurse optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local noundef <span class="type">i32</span> <span class="title">@main</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@puts</span>(<span class="type">i8</span>* noundef <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">28</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">28</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@_ZL3str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> InternalLinkage is similar to
PrivateLinkage. The only difference is that global variables with
internal linkage will show up in the symbol table as a local symbol
(still can't be used by other objects).</p>
<p>Functions with the static modifier also have the InternalLinkage
type: <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test\n&quot;</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> <span class="keyword">internal</span> void <span class="title">@_ZL3foov</span>() <span class="variable">#1</span> &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* noundef <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">ret</span> void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="externallinkage">ExternalLinkage</h2>
<p>ExternalLinage is also a very common linkage types. This linkage type
could be very misleading in the first time. Note that ExternalLinage in
LLVM is not equivalent to the <code>extern</code> keyword in C/C++.
Instead, all global values that are accessible to other objects could
have ExternalLinkage, no matter whether they are defined in current
module or not.</p>
<p>These are all global variables with ExternalLinkage because they are
accessible to other object files at link-time. <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> var1;</span><br><span class="line"><span class="type">int</span> var2 = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ExampleNameSpace &#123;</span><br><span class="line"><span class="type">int</span> var3 = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@var2</span> <span class="operator">=</span> dso_local <span class="keyword">global</span> <span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line"><span class="title">@_ZN16ExampleNameSpace4var3E</span> <span class="operator">=</span> dso_local <span class="keyword">global</span> <span class="type">i32</span> <span class="number">2</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line"><span class="title">@var1</span> <span class="operator">=</span> <span class="keyword">external</span> dso_local <span class="keyword">global</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<p>Note that global values in anonymous namespace don't have
ExternalLinkage because they are inaccessible to other modules.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"><span class="type">int</span> var4 = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@_ZN12_GLOBAL__N_14var4E</span> <span class="operator">=</span> <span class="keyword">internal</span> <span class="keyword">global</span> <span class="type">i32</span> <span class="number">3</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>This rule also applies to functions. For conciseness of this post, I
decide not to include the examples here.</p>
<h2 id="appendinglinkage">AppendingLinkage</h2>
<p>This linkage type doesn't really exist in general linkers. It's only
used for some special variables generated by LLVM like
<code>llvm.global_ctors</code>, which is an array that stores functions
to execute before the main function. In the case of ELF file, the
<code>llvm.global_ctors</code> will be compiled to
<code>.init.array</code> later in the compilation process. Global
variables with AppendingLinkage must be a pointer to an array and
equivalent global variables with AppendingLinkage will be merged by
appending their array contents togother.</p>
<p>Here is a simple example. I defined two constructor functions in
1.cpp and 2.cpp respectively, and compiled them to LLVM IR.
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">startupfun1</span><span class="params">(<span class="type">void</span>)</span> __<span class="title">attribute__</span><span class="params">((constructor))</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;Hello, 1.cpp\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">startupfun2</span><span class="params">(<span class="type">void</span>)</span> __<span class="title">attribute__</span><span class="params">((constructor))</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;Hello, 2.cpp\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure> I got an array with a pointer to function
<code>startupfun1</code> in 1.ll, and an array with a pointer to
function <code>startupfun2</code> in 2.ll. <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@llvm.global_ctors</span> <span class="operator">=</span> <span class="keyword">appending</span> <span class="keyword">global</span> [<span class="number">1</span> <span class="keyword">x</span> &#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125;] [&#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125; &#123; <span class="type">i32</span> <span class="number">65535</span><span class="punctuation">,</span> void ()* <span class="title">@_Z11startupfun1v</span><span class="punctuation">,</span> <span class="type">i8</span>* <span class="keyword">null</span> &#125;]</span><br></pre></td></tr></table></figure> <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@llvm.global_ctors</span> <span class="operator">=</span> <span class="keyword">appending</span> <span class="keyword">global</span> [<span class="number">1</span> <span class="keyword">x</span> &#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125;] [&#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125; &#123; <span class="type">i32</span> <span class="number">65535</span><span class="punctuation">,</span> void ()* <span class="title">@_Z11startupfun2v</span><span class="punctuation">,</span> <span class="type">i8</span>* <span class="keyword">null</span> &#125;]</span><br></pre></td></tr></table></figure>
These two arrays are combined into one array with two functions after
linked by llvm-link: <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@llvm.global_ctors</span> <span class="operator">=</span> <span class="keyword">appending</span> <span class="keyword">global</span> [<span class="number">2</span> <span class="keyword">x</span> &#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125;] [&#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125; &#123; <span class="type">i32</span> <span class="number">65535</span><span class="punctuation">,</span> void ()* <span class="title">@_Z11startupfun1v</span><span class="punctuation">,</span> <span class="type">i8</span>* <span class="keyword">null</span> &#125;<span class="punctuation">,</span> &#123; <span class="type">i32</span><span class="punctuation">,</span> void ()*<span class="punctuation">,</span> <span class="type">i8</span>* &#125; &#123; <span class="type">i32</span> <span class="number">65535</span><span class="punctuation">,</span> void ()* <span class="title">@_Z11startupfun2v</span><span class="punctuation">,</span> <span class="type">i8</span>* <span class="keyword">null</span> &#125;]</span><br></pre></td></tr></table></figure></p>
<h2 id="linkonceanylinkage-linkonceodrlinkage">LinkOnceAnyLinkage &amp;
LinkOnceODRLinkage</h2>
<p>LinkOnceAnyLinkage/LinkOnceODRLinkage is used to implement inline and
template functions. The difference between inline/template functions and
normal functions is that inline/template functions must be defined in
each translation unit that uses this function.</p>
<p>LinkOnceAny and LinkOnceODR are very similar, but LinkOnceAny linkage
allows nonequivalent global values to be merged, which is a feature that
is not required by inline/template functions (clang and gcc don't
actually check whether two global values are equivalent though). In my
experience, LinkOnceODRLinkage is far more common than LinkOnceLinkage
in C++. For more information about ODR: <a
target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/definition">Definitions
and ODR (One Definition Rule)</a></p>
<h3 id="inline-function">Inline Function</h3>
<p>For inline function, if you want to inline a function into callers,
you must know the exact definition of this function. The definition of
the inline function and it's callers must be in the same translation
unit, because function inlining is performed at optimization phase.
During optimization stage, the compiler doesn't have direct access to
other object files. If the inline function's definition is in a
different module from it's callers, the compiler usually won't throw an
error, but the function will never be inlined.</p>
<p>Below is a simple example:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;hello\n&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; <span class="built_in">foo</span>(); &#125;</span><br></pre></td></tr></table></figure>
<p>If compiled with <code>-O0</code> optimization level, the
<code>foo</code> function will not be inlined. The <code>foo</code>
function is marked with the <code>linkonce_odr</code> linkage. If other
modules also use the same inline function, these inline functions will
be merged into one definition at link-time. This is what the linkonce
linkage is for - to avoid duplication or collision at link-time if an
inline function is not actually inlined. Note that compiler won't
necessarily inline functions with <code>inline</code> modifer. Instead,
the compiler only uses it as a hint. For more detailed explanation: <a
target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1759300/when-should-i-write-the-keyword-inline-for-a-function-method">When
should I write the keyword 'inline' for a function/method?</a>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Function Attrs: mustprogress noinline norecurse optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local noundef <span class="type">i32</span> <span class="title">@main</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="keyword">call</span> void <span class="title">@_Z3foov</span>()</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: mustprogress noinline optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="keyword">linkonce_odr</span> dso_local void <span class="title">@_Z3foov</span>() <span class="variable">#1</span> comdat &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* noundef <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">7</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">7</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">ret</span> void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>If compiled with <code>-O1</code> or higher optimization level, the
<code>foo</code> function will be directly inlined into it's caller, and
the <code>foo</code> function is discarded. <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Function Attrs: mustprogress nofree norecurse nounwind uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local noundef <span class="type">i32</span> <span class="title">@main</span>() local_unnamed_addr <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@puts</span>(<span class="type">i8</span>* nonnull dereferenceable(<span class="number">1</span>) <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="template-function">Template Function</h3>
<p>Following is an example of template function usage. We can see the
<code>myMax</code> function is called three times with different
template type. <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++ Program to demonstrate</span></span><br><span class="line"><span class="comment">// Use of template</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// One function works for all data types.  This would work</span></span><br><span class="line"><span class="comment">// even for user defined types if operator &#x27;&gt;&#x27; is overloaded</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function">T <span class="title">myMax</span><span class="params">(T x, T y)</span> </span>&#123; <span class="keyword">return</span> (x &gt; y) ? x : y; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Call myMax for int</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">myMax</span>&lt;<span class="type">int</span>&gt;(<span class="number">3</span>, <span class="number">7</span>) &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// call myMax for double</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">myMax</span>&lt;<span class="type">double</span>&gt;(<span class="number">3.0</span>, <span class="number">7.0</span>) &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// call myMax for char</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">myMax</span>&lt;<span class="type">char</span>&gt;(<span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;e&#x27;</span>) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> In this case, this template function will
be expanded to three monomorphic versions. These functions are almost
identical. The only difference is that they use different data types to
adapt to different calls. <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Function Attrs: mustprogress noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="keyword">linkonce_odr</span> dso_local noundef <span class="type">i32</span> <span class="title">@_Z5myMaxIiET_S0_S0_</span>(<span class="type">i32</span> noundef <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span> noundef <span class="variable">%1</span>) <span class="variable">#5</span> comdat &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: mustprogress noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="keyword">linkonce_odr</span> dso_local noundef <span class="keyword">double</span> <span class="title">@_Z5myMaxIdET_S0_S0_</span>(<span class="keyword">double</span> noundef <span class="variable">%0</span><span class="punctuation">,</span> <span class="keyword">double</span> noundef <span class="variable">%1</span>) <span class="variable">#5</span> comdat &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: mustprogress noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="keyword">linkonce_odr</span> dso_local noundef <span class="keyword">signext</span> <span class="type">i8</span> <span class="title">@_Z5myMaxIcET_S0_S0_</span>(<span class="type">i8</span> noundef <span class="keyword">signext</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i8</span> noundef <span class="keyword">signext</span> <span class="variable">%1</span>) <span class="variable">#5</span> comdat &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> Like inline function, template
function should also be defined in the same translation unit with it's
callers, otherwise the compiler will yield an error. Imagine that a
module feeds the template functions with three different data types -
int, char, and double. In return it needs three different monomorphic
definitions of this function at link-time. However, when compiler
compiles the module that contains the template function, the compiler
doesn't know how many types of monomorphic functions it is supposed to
generate! For more details: <a
target="_blank" rel="noopener" href="https://www.educative.io/answers/why-can-templates-only-be-implemented-in-the-header-file-in-cpp">Why
Can templates only be implemented in the header file in C++</a></p>
<p>In practice, template functions are usually written in header files
so that different modules can include and use the template functions
with ease. At link-time, duplicate definitions will be merged into one
because they all have LinkOnceODRLinkage.</p>
<h2 id="weakanylinkage-weakodrlinkage">WeakAnyLinkage &amp;
WeakODRLinkage</h2>
<p>Weak linkage is almost the same as linkonce, except that unreferenced
globals with weak linkage may not be discarded. In addition, weak
definitions can be overrided by normal definitions. This linkage type is
used for globals that are declared "weak" in C source code.</p>
<p>For example, in 1.cpp we have, <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> __<span class="title">attribute__</span><span class="params">((weak))</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;Hello\n&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; <span class="built_in">foo</span>(); &#125;</span><br></pre></td></tr></table></figure> In 2.cpp, we have,
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;World!\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure> The first <code>foo</code> function will be overrided by
the second one.</p>
<p>But as far as I know, this feature is not commonly used in
practice.</p>
<h2 id="commonlinkage">CommonLinkage</h2>
<p>Common linkage is most similar to weak linkage, but has more
restrictions: - Symbols with common linkage must have a zero initializer
- Symbols with common linkage may not be marked as constant</p>
<p>According to LLVM official documents, this linkage type is used for
tentative definitions in C, such as <code>int X;</code> at global scope.
But I didn't see clang produces this type of global values in my
experiment.</p>
<h2 id="availableexternallylinkage">AvailableExternallyLinkage</h2>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/2024/04/27/VariableRecovery-Internals-in-angr/" rel="next" title="VariableRecovery Internals in angr">
                  VariableRecovery Internals in angr <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Yibo Liu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
